@using WarriorExperiment.Core.Services
@using WarriorExperiment.Persistence.Models
@inject WaUserService UserService
@inject NotificationService NotificationService
@inherits WaBaseComponent
@implements IDisposable

<RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" class="wa-user-selector">
    @if (isLoading)
    {
        <RadzenIcon Icon="person" Style="color: var(--rz-text-color);" class="wa-user-icon" />
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.ExtraSmall" />
        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);" class="wa-loading-text">Loading users...</RadzenText>
    }
    else if (users.Any())
    {
        <!-- User Avatar/Initials -->
        @if (currentUser != null)
        {
            <div class="user-avatar" title="@currentUser.UserName">
                @GetUserInitials()
            </div>
        }
        else
        {
            <RadzenIcon Icon="person" Style="color: var(--rz-text-color);" class="wa-user-icon" />
        }
        
        <!-- User Selection Dropdown -->
        <RadzenDropDown @bind-Value="selectedUserId" 
                      Data="@users" 
                      TextProperty="UserName" 
                      ValueProperty="Id"
                      Change="@OnUserSelectionChanged"
                      Placeholder="Select User..."
                      class="wa-user-dropdown" />
                      
        <!-- User Info Display -->
        @if (currentUser != null)
        {
            <RadzenStack Orientation="Orientation.Vertical" Gap="0" class="wa-user-info">
                <RadzenText TextStyle="TextStyle.Caption" class="wa-user-details">
                    @GetUserDisplayInfo()
                </RadzenText>
                @if (currentUser.DateOfStart.HasValue)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="wa-user-start-date">
                        Started @currentUser.DateOfStart.Value.ToString("MMM yyyy")
                    </RadzenText>
                }
            </RadzenStack>
        }
    }
    else
    {
        <RadzenIcon Icon="person_off" Style="color: var(--rz-text-secondary-color);" class="wa-user-icon" />
        <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);" class="wa-no-users-text">
            No users found
        </RadzenText>
    }
</RadzenStack>

<style>
    /* User selector responsive styles */
    .wa-user-selector {
        flex-wrap: wrap;
        min-height: 44px;
    }

    .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        border: 2px solid var(--rz-primary-light);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex-shrink: 0;
    }

    .wa-user-icon {
        flex-shrink: 0;
        font-size: 1.2rem;
    }

    .wa-user-dropdown {
        min-width: 150px;
        max-width: 200px;
        border-radius: 4px;
    }

    .wa-user-info {
        line-height: 1.2;
        flex-shrink: 1;
        min-width: 0; /* Allow text to truncate */
    }

    .wa-user-details {
        color: var(--rz-text-secondary-color);
        margin: 0;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .wa-user-start-date {
        color: var(--rz-text-tertiary-color);
        margin: 0;
        font-size: 0.7rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .wa-loading-text,
    .wa-no-users-text {
        font-size: 0.8rem;
        white-space: nowrap;
    }

    /* Mobile responsive adjustments */
    @@media (max-width: 768px) {
        .wa-user-selector {
            gap: 0.25rem;
            justify-content: flex-end;
            flex-wrap: nowrap;
            overflow: hidden;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            font-size: 0.7rem;
        }

        .wa-user-icon {
            font-size: 1rem;
        }

        .wa-user-dropdown {
            min-width: 120px;
            max-width: 150px;
            font-size: 0.8rem;
        }

        .wa-user-info {
            display: none; /* Hide detailed info on mobile to save space */
        }

        .wa-loading-text,
        .wa-no-users-text {
            font-size: 0.7rem;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .wa-user-details {
            font-size: 0.7rem;
        }

        .wa-user-start-date {
            font-size: 0.6rem;
        }
    }

    @@media (max-width: 480px) {
        .wa-user-selector {
            gap: 0.2rem;
        }

        .user-avatar {
            width: 24px;
            height: 24px;
            font-size: 0.6rem;
            border-width: 1px;
        }

        .wa-user-icon {
            font-size: 0.9rem;
        }

        .wa-user-dropdown {
            min-width: 100px;
            max-width: 120px;
            font-size: 0.7rem;
        }

        .wa-loading-text,
        .wa-no-users-text {
            font-size: 0.6rem;
            max-width: 80px;
        }
    }

    /* Landscape mobile adjustments */
    @@media (max-width: 768px) and (orientation: landscape) {
        .wa-user-info {
            display: flex; /* Show info in landscape */
        }

        .wa-user-details,
        .wa-user-start-date {
            max-width: 100px;
        }
    }

    /* Touch-friendly improvements */
    @@media (max-width: 768px) {
        .wa-user-dropdown {
            min-height: 40px;
        }

        .user-avatar {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .user-avatar:active {
            transform: scale(0.95);
        }
    }

    /* High DPI screen adjustments */
    @@media (min-resolution: 2dppx) {
        .user-avatar {
            border-width: 1px;
        }
    }
</style>

@code {
    [Parameter] public EventCallback<WaUser?> OnCurrentUserChanged { get; set; }
    
    private List<WaUser> users = new();
    private WaUser? currentUser;
    private int? selectedUserId;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        await LoadCurrentUser();
        
        // Subscribe to user service events
        UserService.CurrentUserChanged += HandleCurrentUserChanged;
    }
    
    private async Task LoadUsers()
    {
        try
        {
            users = await UserService.GetAllAsync();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, $"Error loading users: {ex.Message}");
        }
    }
    
    private async Task LoadCurrentUser()
    {
        try
        {
            currentUser = await UserService.GetCurrentUserAsync();
            selectedUserId = currentUser?.Id;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, $"Error loading current user: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task OnUserSelectionChanged(object? value)
    {
        if (value is int userId)
        {
            try
            {
                var user = await UserService.SetCurrentUserAsync(userId);
                if (user != null)
                {
                    currentUser = user;
                    selectedUserId = userId;
                    await OnCurrentUserChanged.InvokeAsync(user);
                    NotificationService.Notify(NotificationSeverity.Success, $"Switched to user: {user.UserName}");
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "User not found");
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, $"Error switching user: {ex.Message}");
            }
        }
    }
    
    private void HandleCurrentUserChanged(WaUser? user)
    {
        currentUser = user;
        selectedUserId = user?.Id;
        InvokeAsync(StateHasChanged);
    }
    
    private string GetUserInitials()
    {
        if (currentUser == null || string.IsNullOrEmpty(currentUser.UserName))
            return "?";
            
        var parts = currentUser.UserName.Split(new[] { ' ', '_', '-', '.' }, StringSplitOptions.RemoveEmptyEntries);
        
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}";
        }
        else if (parts.Length == 1 && parts[0].Length >= 2)
        {
            return $"{parts[0][0]}{parts[0][1]}";
        }
        else
        {
            return parts[0][0].ToString();
        }
    }
    
    private string GetUserDisplayInfo()
    {
        if (currentUser == null) return "";
        
        var info = new List<string>();
        
        if (currentUser.Height.HasValue)
        {
            info.Add($"{currentUser.Height:0}cm");
        }
        
        if (currentUser.BirthDate.HasValue)
        {
            var age = DateTime.Today.Year - currentUser.BirthDate.Value.Year;
            if (currentUser.BirthDate.Value.Date > DateTime.Today.AddYears(-age))
                age--;
            info.Add($"Age {age}");
        }
        
        return info.Any() ? string.Join(", ", info) : "No info";
    }
    
    public void Dispose()
    {
        UserService.CurrentUserChanged -= HandleCurrentUserChanged;
    }
}