@using WarriorExperiment.Persistence.Entities
@using WarriorExperiment.Persistence.Validators
@using Blazored.FluentValidation
@using Microsoft.JSInterop
@inherits WaBaseComponent
@inject IJSRuntime JSRuntime

<EditForm Model="@Model" OnValidSubmit="@HandleValidSubmit">
    <FluentValidationValidator />
    
    <RadzenStack Gap="1rem">
        <RadzenCard>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.H5">Body Measurement Entry</RadzenText>
                
                <!-- Date -->
                <RadzenFormField Text="Date" AllowFloatingLabel="false">
                    <RadzenDatePicker @bind-Value="@Model.Date" ShowTime="false" DateFormat="yyyy-MM-dd" />
                </RadzenFormField>
                
                <!-- Measurement Method (placeholder for now) -->
                <RadzenFormField Text="Measurement Method ID" AllowFloatingLabel="false">
                    <RadzenNumeric @bind-Value="@Model.MeasurementMethodId" Min="1" />
                </RadzenFormField>
                
                <!-- Photos Section -->
                <RadzenText TextStyle="TextStyle.H6">Photos (Optional)</RadzenText>
                
                <!-- Front Photo -->
                <RadzenFormField Text="Front Photo" AllowFloatingLabel="false">
                    <RadzenStack Gap="0.5rem">
                        @if (!string.IsNullOrEmpty(Model.FrontPhoto))
                        {
                            <div style="position: relative; display: inline-block;">
                                <img src="data:image/jpeg;base64,@Model.FrontPhoto" style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 4px;" />
                                <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                            Click="@(() => DeletePhoto("front"))"
                                            Style="position: absolute; top: 5px; right: 5px;" />
                            </div>
                        }
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Take Photo" Icon="photo_camera" Size="ButtonSize.Small"
                                        Click="@(() => CapturePhoto("front"))" />
                            <RadzenButton Text="Choose File" Icon="folder_open" Size="ButtonSize.Small" 
                                        ButtonStyle="ButtonStyle.Light"
                                        Click="@(() => SelectFile("front"))" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenFormField>
                
                <!-- Back Photo -->
                <RadzenFormField Text="Back Photo" AllowFloatingLabel="false">
                    <RadzenStack Gap="0.5rem">
                        @if (!string.IsNullOrEmpty(Model.BackPhoto))
                        {
                            <div style="position: relative; display: inline-block;">
                                <img src="data:image/jpeg;base64,@Model.BackPhoto" style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 4px;" />
                                <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                            Click="@(() => DeletePhoto("back"))"
                                            Style="position: absolute; top: 5px; right: 5px;" />
                            </div>
                        }
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Take Photo" Icon="photo_camera" Size="ButtonSize.Small"
                                        Click="@(() => CapturePhoto("back"))" />
                            <RadzenButton Text="Choose File" Icon="folder_open" Size="ButtonSize.Small" 
                                        ButtonStyle="ButtonStyle.Light"
                                        Click="@(() => SelectFile("back"))" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenFormField>
                
                <!-- Side Photo -->
                <RadzenFormField Text="Side Photo" AllowFloatingLabel="false">
                    <RadzenStack Gap="0.5rem">
                        @if (!string.IsNullOrEmpty(Model.SidePhoto))
                        {
                            <div style="position: relative; display: inline-block;">
                                <img src="data:image/jpeg;base64,@Model.SidePhoto" style="max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 4px;" />
                                <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger"
                                            Click="@(() => DeletePhoto("side"))"
                                            Style="position: absolute; top: 5px; right: 5px;" />
                            </div>
                        }
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Take Photo" Icon="photo_camera" Size="ButtonSize.Small"
                                        Click="@(() => CapturePhoto("side"))" />
                            <RadzenButton Text="Choose File" Icon="folder_open" Size="ButtonSize.Small" 
                                        ButtonStyle="ButtonStyle.Light"
                                        Click="@(() => SelectFile("side"))" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenFormField>
                
                <!-- Body Composition Section -->
                <RadzenText TextStyle="TextStyle.H6">Body Composition (Optional)</RadzenText>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Weight (kg)" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.Weight" Min="20M" Max="500M" Step="0.1M" 
                                         Change="@((decimal? value) => OnWeightChanged(value))" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Body Fat (%)" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.BodyFat" Min="5M" Max="50M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Muscle Mass (%)" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.MuscleMassPercentage" Min="20M" Max="60M" Step="0.1M" 
                                         Change="@((decimal? value) => OnMuscleMassPercentageChanged(value))" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Muscle Mass (kg) - Calculated" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.MuscleMass" Min="10M" Max="150M" Step="0.1M" 
                                         Disabled="true" Style="background-color: #f8f9fa;" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Auto-calculated from weight and percentage
                            </RadzenText>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="BMI - Calculated" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.BMI" Min="10M" Max="60M" Step="0.1M" 
                                         Disabled="true" Style="background-color: #f8f9fa;" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Auto-calculated from weight and height
                            </RadzenText>
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Metabolic Age (years)" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.MetabolicAge" Min="10" Max="100" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenRow>
                    <RadzenColumn Size="12">
                        <RadzenFormField Text="Visceral Fat Level (1-30)" AllowFloatingLabel="false">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                <RadzenNumeric @bind-Value="@Model.VisceralFat" Min="1" Max="30" Style="flex: 1;" />
                                @if (Model.VisceralFat.HasValue)
                                {
                                    <RadzenBadge Text="@GetVisceralFatCategory()" 
                                               Style="@($"background-color: {GetVisceralFatCategoryColor()}; color: white;")" />
                                }
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                1-9: Normal, 10-14: High, 15-30: Very High
                            </RadzenText>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenFormField Text="Basal Metabolic Rate (calories)" AllowFloatingLabel="false">
                    <RadzenNumeric @bind-Value="@Model.BasalMetabolicRate" Min="500" Max="5000" />
                </RadzenFormField>
                
                <!-- Circumference Measurements Section -->
                <RadzenText TextStyle="TextStyle.H6">Circumference Measurements (cm, Optional)</RadzenText>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Chest Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.ChestCircumference" Min="50M" Max="200M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Waist Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.WaistCircumference" Min="40M" Max="200M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Hip Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.HipCircumference" Min="50M" Max="200M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Bicep Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.BicepCircumference" Min="15M" Max="60M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <RadzenRow>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Thigh Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.ThighCircumference" Min="30M" Max="100M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="6">
                        <RadzenFormField Text="Calf Circumference" AllowFloatingLabel="false">
                            <RadzenNumeric @bind-Value="@Model.CalfCircumference" Min="20M" Max="60M" Step="0.1M" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                
                <!-- Notes -->
                <RadzenFormField Text="Notes (Optional)" AllowFloatingLabel="false">
                    <RadzenTextArea @bind-Value="@Model.Notes" Rows="3" Placeholder="Optional notes..." />
                </RadzenFormField>
                
                <!-- Validation Summary -->
                <ValidationSummary />
                
                <!-- Submit Button -->
                <RadzenButton ButtonType="ButtonType.Submit" Text="Save Measurement" ButtonStyle="ButtonStyle.Primary" Icon="save" />
            </RadzenStack>
        </RadzenCard>
    </RadzenStack>
</EditForm>

@code {
    [Parameter] public WaMeasurementEntry Model { get; set; } = new();
    [Parameter] public EventCallback<WaMeasurementEntry> OnValidSubmit { get; set; }
    [CascadingParameter] public WaUser? CurrentUser { get; set; }
    
    private void OnWeightChanged(decimal? value)
    {
        CalculateBMI();
        CalculateMuscleMassKg();
    }
    
    private void OnMuscleMassPercentageChanged(decimal? value)
    {
        CalculateMuscleMassKg();
    }
    
    private void CalculateBMI()
    {
        if (Model.Weight.HasValue && CurrentUser?.Height.HasValue == true)
        {
            var heightInMeters = CurrentUser.Height.Value / 100m; // Convert cm to meters
            Model.BMI = Math.Round(Model.Weight.Value / (heightInMeters * heightInMeters), 2);
        }
        else
        {
            Model.BMI = null;
        }
    }
    
    private void CalculateMuscleMassKg()
    {
        if (Model.Weight.HasValue && Model.MuscleMassPercentage.HasValue)
        {
            Model.MuscleMass = Math.Round(Model.Weight.Value * Model.MuscleMassPercentage.Value / 100, 2);
        }
        else
        {
            Model.MuscleMass = null;
        }
    }
    
    private string GetVisceralFatCategory()
    {
        return Model.GetVisceralFatCategory();
    }
    
    private string GetVisceralFatCategoryColor()
    {
        return Model.GetVisceralFatCategoryColor();
    }
    
    private async Task CapturePhoto(string photoType)
    {
        try
        {
            var base64Image = await JSRuntime.InvokeAsync<string>("capturePhoto");
            if (!string.IsNullOrEmpty(base64Image))
            {
                SetPhoto(photoType, base64Image);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error capturing photo: {ex.Message}");
        }
    }
    
    private async Task SelectFile(string photoType)
    {
        try
        {
            var base64Image = await JSRuntime.InvokeAsync<string>("selectFile");
            if (!string.IsNullOrEmpty(base64Image))
            {
                SetPhoto(photoType, base64Image);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error selecting file: {ex.Message}");
        }
    }
    
    private void DeletePhoto(string photoType)
    {
        SetPhoto(photoType, null);
        StateHasChanged();
    }
    
    private void SetPhoto(string photoType, string? base64Data)
    {
        switch (photoType.ToLower())
        {
            case "front":
                Model.FrontPhoto = base64Data;
                break;
            case "back":
                Model.BackPhoto = base64Data;
                break;
            case "side":
                Model.SidePhoto = base64Data;
                break;
        }
    }
    
    private async Task HandleValidSubmit()
    {
        await OnValidSubmit.InvokeAsync(Model);
    }
}